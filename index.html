<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Transmission InterceptÃ©e</title>

<style>
html, body {
    min-height:100%;
}

body {
    margin:0;
    background: radial-gradient(circle at center, #150000 0%, #000 80%);
    color: #f5f5f5;
    font-family: "Consolas", monospace;
    text-align: center;
    overflow-y:auto;
    transition: background 1.5s ease;
}

body::before {
    content: "";
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    pointer-events:none;
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,0,0,0.05),
        rgba(255,0,0,0.05) 2px,
        transparent 2px,
        transparent 4px
    );
    animation: flicker 0.2s infinite;
    transition: opacity 1.5s ease;
}

@keyframes flicker {
    0% {opacity:0.95;}
    50% {opacity:1;}
    100% {opacity:0.97;}
}

body.activated {
    background: radial-gradient(circle at center, #400000 0%, #000 70%);
}

body.activated::before {
    background: repeating-linear-gradient(
        to bottom,
        rgba(255,0,0,0.12),
        rgba(255,0,0,0.12) 2px,
        transparent 2px,
        transparent 4px
    );
}

.screen {
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    height:100vh;
}

button {
    padding: 12px 35px;
    background: black;
    color: gold;
    border: 2px solid darkred;
    font-size: 16px;
    letter-spacing:2px;
    cursor:pointer;
    margin-top:20px;
}

button:hover { background:#220000; }

#loading {
    margin-top:30px;
    color: gold;
    font-size:14px;
    display:none;
}

#mainContent {
    display:none;
    padding:40px;
    max-width:1000px;
    margin:auto;
}

h1 { color: gold; letter-spacing:4px; }

.message {
    margin-top:30px;
    line-height:1.8;
    min-height:200px;
}

/* ===== GRILLE 6x6 ===== */

.symbols {
    display:grid;
    grid-template-columns:repeat(6,90px);
    grid-template-rows:repeat(6,90px);
    gap:10px;
    margin-top:40px;
    opacity:0.4;
    pointer-events:none;
    justify-content:center;
}

.symbols img {
    width:90px;
    height:90px;
    cursor:pointer;
    border:1px solid #330000;
    background:black;
    padding:10px;
    transition:0.15s;
}

.symbols img:hover {
    transform:scale(1.05);
    border:1px solid gold;
}

.slots {
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:30px;
}

.slot {
    width:60px;
    height:60px;
    border:1px solid darkred;
    background:black;
    display:flex;
    align-items:center;
    justify-content:center;
}

#result {
    margin-top:25px;
    color:gold;
    min-height:20px;
}
</style>
</head>

<body>

<div class="screen" id="startScreen">
    <button onclick="startSequence()">DÃ‰MARRER TRANSMISSION</button>
    <div id="loading">Connexion sÃ©curisÃ©e...</div>
</div>

<div id="mainContent">
    <h1>TRANSMISSION INTERCEPTÃ‰E</h1>
    <div class="message" id="typedText"></div>

    <div class="symbols" id="symbolGrid"></div>

    <div class="slots">
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
        <div class="slot"></div>
    </div>

    <button id="resetBtn" onclick="reset()">RÃ‰INITIALISER</button>

    <div id="result"></div>
</div>

<audio id="bgMusic" src="ambience.mp3" loop></audio>

<script>
let selection = [];
let locked = false;
let musicStarted = false;
let typingFinished = false;

const centreX = 2.5;
const centreY = 2.5;

const bgMusic = document.getElementById("bgMusic");
const soundClick = new Audio("click.mp3");
const soundFalse = new Audio("error.mp3");
const soundTrue = new Audio("success.mp3");
const soundType = new Audio("type.mp3");
const soundEnd = new Audio("type_end.mp3");

bgMusic.volume = 0.2;

const message = `Ce message nâ€™a pas dâ€™auteur.

Il a une origine.

Nous ne nommons pas les individus.
Nous identifions les points de convergence.

Cherchez ce qui nâ€™est ni un titre,
ni une fonction,
mais un centre autour duquel lâ€™ordre sâ€™organise.

Traduisez.
Assemblez.
Entrez ce qui demeure lorsque tout le reste disparaÃ®t.`;

/* ===== SYMBOLS FIXES ===== */

const uniques = {
    "2-3": {letter:"A", img:"D17.png"},
    "1-2": {letter:"R", img:"D18.png"},
    "0-1": {letter:"K", img:"D19.png"},
    "4-5": {letter:"U", img:"D20.png"},
    "5-5": {letter:"S", img:"D21.png"}
};

const duplicates = [];
for(let i=1;i<=16;i++){
    duplicates.push("D"+i+".png");
    duplicates.push("D"+i+".png");
}

let dupIndex = 0;

function startSequence() {
    document.getElementById("loading").style.display = "block";

    if (!musicStarted) {
        bgMusic.play().catch(()=>{});
        musicStarted = true;
    }

    setTimeout(() => {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        typeWriter();
        generateGrid();
    }, 2000);
}

function generateGrid(){
    const grid = document.getElementById("symbolGrid");

    // Reset au cas oÃ¹
    grid.innerHTML = "";
    dupIndex = 0;

    // ðŸ”€ MÃ©lange des doublons (Fisher-Yates shuffle)
    const shuffledDuplicates = [...duplicates];
    for (let i = shuffledDuplicates.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledDuplicates[i], shuffledDuplicates[j]] =
        [shuffledDuplicates[j], shuffledDuplicates[i]];
    }

    for(let row=0;row<6;row++){
        for(let col=0;col<6;col++){

            const key=row+"-"+col;
            const img=document.createElement("img");

            img.dataset.row=row;
            img.dataset.col=col;

            if(uniques[key]){
                img.src=uniques[key].img;
                img.dataset.letter=uniques[key].letter;
            } else {
                img.src=shuffledDuplicates[dupIndex];
                img.dataset.letter="X";
                dupIndex++;
            }

            img.onclick=selectUnique;
            grid.appendChild(img);
        }
    }
}


function typeWriter() {
    let i = 0;
    const speed = 20;
    const target = document.getElementById("typedText");

    function typing() {
        if (i < message.length) {
            if(message.charAt(i) !== "\n"){
                soundType.currentTime = 0;
                soundType.volume = 0.15;
                soundType.play().catch(()=>{});
            }
            target.innerHTML += message.charAt(i) === "\n" ? "<br>" : message.charAt(i);
            i++;
            setTimeout(typing, speed);
        } else {
            typingFinished = true;
            soundEnd.play().catch(()=>{});
            document.getElementById("symbolGrid").style.opacity = "1";
            document.getElementById("symbolGrid").style.pointerEvents = "auto";
        }
    }
    typing();
}

function selectUnique(){
    if (!typingFinished || locked || selection.length>=5) return;

    soundClick.currentTime=0;
    soundClick.play().catch(()=>{});

    const letter=this.dataset.letter;
    const row=parseInt(this.dataset.row);
    const col=parseInt(this.dataset.col);

    selection.push({
        letter:letter,
        distance:Math.sqrt(
            Math.pow(row-centreX,2)+
            Math.pow(col-centreY,2)
        )
    });

    const slot=document.getElementsByClassName("slot")[selection.length-1];
    const clone=this.cloneNode(true);
    slot.appendChild(clone);

    if(selection.length===5) verifier();
}

function verifier(){

    selection.sort((a,b)=>a.distance-b.distance);
    const code=selection.map(s=>s.letter).join("");

    if (code === "ARKUS") {
        locked = true;
        document.body.classList.add("activated");
        document.getElementById("resetBtn").style.display = "none";
        document.getElementById("result").innerText = "CANAL VALIDÃ‰";
        fadeMusic(0.05, 800);
        soundTrue.play().catch(()=>{});
        soundTrue.onended = function() {
            window.location.href = "countdown.html";
        };
    } else {
        soundFalse.play().catch(()=>{});
        document.getElementById("result").innerText =
            "Correspondance invalide.";
        setTimeout(reset, 1500);
    }
}

function reset() {
    if (locked) return;
    selection = [];
    document.getElementById("result").innerText = "";
    const slots = document.getElementsByClassName("slot");
    for (let s of slots) s.innerHTML = "";
}

function fadeMusic(target, duration) {
    let step = 0.01;
    let interval = duration / ((bgMusic.volume - target) / step);

    let fade = setInterval(() => {
        if (bgMusic.volume > target) {
            bgMusic.volume = Math.max(bgMusic.volume - step, target);
        } else {
            clearInterval(fade);
        }
    }, interval);
}
</script>

</body>
</html>
